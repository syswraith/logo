<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="title" content="Logo REPL by syswraith">
    <meta name="description" content="Interactive Logo interpreter and canvas by syswraith. Run Logo programs directly in the browser.">
    <meta name="keywords" content="logo, repl, interpreter, turtle graphics, syswraith">
    <meta property="og:title" content="Logo REPL by syswraith">
    <meta property="og:description" content="An interactive in-browser Logo interpreter built by syswraith.">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Logo REPL by syswraith">
    <meta name="twitter:description" content="Interactive Logo interpreter by syswraith.">
    <link rel='stylesheet' href='./style.css'/>
    <title>Canvas + Editor Layout</title>
  </head>
  <body>
    <div class="layout">
      <div class="left">
        <canvas id="canvas" width="900" height="900"></canvas>
        <button id="export">Export</button>
      </div>
      <div class="right">
        <textarea id="editor"></textarea>
        <button id="run">Run</button>
      </div>
    </div>
    <script src="./LogoCore.js"></script>
    <script>
    const { Tokenizer, Parser } = LogoCore;
    const canvas = document.getElementById("canvas");
    const exportBtn = document.getElementById("export");
    const editor = document.getElementById("editor");
    const runBtn = document.getElementById("run");

    const ctx = canvas.getContext("2d");
    const turtle = {x:450, y:450, angle:0, pen:true};

    function toRadians(angle) {
      return (angle * Math.PI) / 180;
    }

    function computeVector(angle, distance) {
      const r = (angle - 90) * Math.PI / 180;
      return {
        dx: distance * Math.cos(r),
        dy: distance * Math.sin(r)
      };
    }

    function moveTurtle(turtle, dx, dy) {
      turtle.x += dx;
      turtle.y += dy;
    }

    function drawLine(x1, y1, x2, y2) {
      if(!turtle.pen) return;
      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      ctx.stroke();
    }

    function forward(turtle, distance) {
      const startX = turtle.x;
      const startY = turtle.y;
      const v = computeVector(turtle.angle, distance);
      moveTurtle(turtle, v.dx, v.dy);
      drawLine(startX, startY, turtle.x, turtle.y);
    }

    function penup(turtle) {turtle.pen=false;}

    function pendown(turtle) {turtle.pen=true;}

    function clearscreen(ctx, canvas) { ctx.clearRect(0,0,canvas.width,canvas.height); }

    function home(turtle,canvas){turtle.x=canvas.width/2;turtle.y=canvas.height/2;turtle.angle=0;}

    const draw = (tree) => {
      tree.forEach(node=>{
        switch (node[0]) {
          case 'FD':
          case 'FORWARD':
            forward(turtle, node[1][0]); 
            break;
          case 'BK':
          case 'BACKWARD':
            forward(turtle, -node[1][0]);
            break;
          case 'LT':
          case 'LEFTTURN':
            turtle.angle -= node[1][0];
            break;
          case 'RT':
          case 'RIGHTTURN':
            turtle.angle += node[1][0];
            break;
          case 'PU':
          case 'PENUP':
            penup(turtle);
            break;
          case 'PD':
          case 'PENDOWN':
            pendown(turtle);
            break;
          case 'CS':
          case 'CLEARSCREEN':
            clearscreen(ctx, canvas);
            break;
          case 'HOME':
            home(turtle, canvas);
            break;

        }
      });

    };

    exportBtn.addEventListener("click", () => {
      const img = canvas.toDataURL("image/png");
      const downloadLink = document.createElement("a");
      downloadLink.href = img;
      downloadLink.download = "canvas.png";
      downloadLink.click();
    });

    runBtn.addEventListener("click", ()=>{
      let editor_content = editor.value;
      editor.value = '';
      const t = new Tokenizer(editor_content);
      const p = new Parser(t.tokens);
      console.log(p.getAST());
      draw(p.getAST());
    })

    </script>
  </body>
</html>
